name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  DEVELOPER_DIR: /Applications/Xcode.app/Contents/Developer

jobs:
  # Build and test Swift Package
  test:
    name: Build and Test
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
      
    - name: Show Xcode version
      run: xcodebuild -version
      
    - name: Cache Swift packages
      uses: actions/cache@v3
      with:
        path: |
          .build
          ~/Library/Developer/Xcode/DerivedData
        key: ${{ runner.os }}-swift-${{ hashFiles('CoverCraftPackage/Package.swift') }}
        restore-keys: |
          ${{ runner.os }}-swift-
    
    - name: Build Swift Package
      working-directory: ./CoverCraftPackage
      run: swift build -c debug
      
    - name: Run Swift Package Tests
      working-directory: ./CoverCraftPackage
      run: swift test --enable-test-discovery --parallel

  # Lint and formatting checks
  lint:
    name: Lint and Format Check
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install SwiftFormat
      run: |
        brew update
        brew install swiftformat
        
    - name: Install SwiftLint
      run: |
        brew update
        brew install swiftlint
        
    - name: Check SwiftFormat
      run: |
        swiftformat --lint CoverCraftPackage/Sources/
        swiftformat --lint CoverCraftPackage/Tests/
        
    - name: Run SwiftLint
      run: |
        cd CoverCraftPackage
        swiftlint lint --strict

  # Security and dependency checks
  security:
    name: Security Scan
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check for security vulnerabilities
      working-directory: ./CoverCraftPackage
      run: |
        # Check Package.swift for known vulnerable dependencies
        echo "Scanning Package.swift for security issues..."
        swift package show-dependencies --format json > dependencies.json
        
        # Basic check for outdated dependencies
        echo "Checking for dependency updates..."
        swift package update --dry-run || true
        
    - name: Upload security scan results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-scan-results
        path: CoverCraftPackage/dependencies.json

  # Contract testing for API stability
  contract-tests:
    name: Contract Tests
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
      
    - name: Run Contract Tests
      working-directory: ./CoverCraftPackage
      run: |
        # Run only the contract tests to validate API stability
        swift test --filter ContractTests
        
    - name: Upload contract test snapshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: contract-snapshots
        path: CoverCraftPackage/Tests/**/__Snapshots__

  # Coverage reporting
  coverage:
    name: Test Coverage
    runs-on: macos-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
      
    - name: Generate test coverage
      working-directory: ./CoverCraftPackage
      run: |
        swift test --enable-code-coverage
        xcrun llvm-cov export -format="lcov" \
          .build/debug/CoverCraftPackageTests.xctest/Contents/MacOS/CoverCraftPackageTests \
          -instr-profile .build/debug/codecov/default.profdata > coverage.lcov
          
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./CoverCraftPackage/coverage.lcov
        flags: swift
        name: CoverCraft Coverage
        fail_ci_if_error: false

  # Build for iOS Simulator (validation)
  ios-build:
    name: iOS Build Validation
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
      
    - name: List available simulators
      run: xcrun simctl list devices available
      
    - name: Build for iOS Simulator
      run: |
        cd CoverCraft.xcworkspace
        xcodebuild -workspace CoverCraft.xcworkspace \
          -scheme CoverCraft \
          -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
          -configuration Debug \
          build

  # Documentation generation
  docs:
    name: Generate Documentation
    runs-on: macos-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install DocC
      run: |
        brew update
        brew install swift-docc-plugin || true
        
    - name: Generate documentation
      working-directory: ./CoverCraftPackage
      run: |
        swift package generate-documentation --target CoverCraftCore
        swift package generate-documentation --target CoverCraftDTO
        
    - name: Deploy documentation
      if: github.ref == 'refs/heads/main'
      run: |
        echo "Documentation generation completed"
        # In a real setup, you'd deploy to GitHub Pages or similar

  # Dependency monitoring
  dependency-monitor:
    name: Monitor Dependencies
    runs-on: macos-latest
    if: github.event_name == 'schedule' || github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check for dependency updates
      working-directory: ./CoverCraftPackage
      run: |
        echo "Checking for available dependency updates..."
        swift package update --dry-run
        swift package show-dependencies --format json > current-deps.json
        
    - name: Create dependency update issue
      if: github.ref == 'refs/heads/main'
      run: |
        echo "Would create GitHub issue for dependency updates if any are available"
        # In real setup, use GitHub API to create issues for updates

# Schedule dependency checks weekly
on:
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9 AM UTC