#!/bin/bash

# Pre-commit hook for CoverCraft
# Ensures code quality before commits

set -e

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}ðŸ” Running pre-commit checks for CoverCraft...${NC}"

# Function to print colored output
print_status() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

print_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

# Check if SwiftLint is installed
if ! command -v swiftlint >/dev/null 2>&1; then
    print_error "SwiftLint is not installed!"
    print_info "Install with: brew install swiftlint"
    exit 1
fi

# Get list of Swift files that are staged
SWIFT_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(swift)$' || true)

if [ -z "$SWIFT_FILES" ]; then
    print_info "No Swift files to check"
    exit 0
fi

print_info "Checking $(echo "$SWIFT_FILES" | wc -l | tr -d ' ') Swift files..."

# Run SwiftLint on staged files
echo "$SWIFT_FILES" | while read -r file; do
    if [ -f "$file" ]; then
        print_info "Linting $file"
        swiftlint lint --quiet --path "$file"
    fi
done

if [ $? -ne 0 ]; then
    print_error "SwiftLint found issues in staged files"
    print_info "Fix the issues above or run 'swiftlint autocorrect' to fix automatically"
    print_info "You can also use --no-verify to skip this check (not recommended)"
    exit 1
fi

print_status "SwiftLint checks passed"

# Check for common issues
print_info "Running additional checks..."

# Check for TODO/FIXME comments in staged files
TODO_COUNT=$(git diff --cached --diff-filter=ACM | grep -E '^\+.*\b(TODO|FIXME|XXX)\b' | wc -l | tr -d ' ')
if [ "$TODO_COUNT" -gt 0 ]; then
    print_warning "Found $TODO_COUNT new TODO/FIXME comments"
    git diff --cached --diff-filter=ACM | grep -E '^\+.*\b(TODO|FIXME|XXX)\b' | head -5
    if [ "$TODO_COUNT" -gt 5 ]; then
        print_info "... and $((TODO_COUNT - 5)) more"
    fi
    print_info "Consider addressing these before committing"
fi

# Check for hardcoded strings that might need localization
HARDCODED_STRINGS=$(git diff --cached --diff-filter=ACM | grep -E '^\+.*"[^"]*[a-zA-Z]{3,}[^"]*"' | grep -v -E '(import|#|//|/\*)' | wc -l | tr -d ' ')
if [ "$HARDCODED_STRINGS" -gt 0 ]; then
    print_warning "Found $HARDCODED_STRINGS potentially hardcoded strings"
    print_info "Consider using localized strings for user-facing text"
fi

# Check for print statements
PRINT_STATEMENTS=$(git diff --cached --diff-filter=ACM | grep -E '^\+.*\bprint\(' | wc -l | tr -d ' ')
if [ "$PRINT_STATEMENTS" -gt 0 ]; then
    print_warning "Found $PRINT_STATEMENTS print statements"
    print_info "Consider using os.Logger for structured logging"
fi

# Check for force unwrapping
FORCE_UNWRAP=$(git diff --cached --diff-filter=ACM | grep -E '^\+.*!' | grep -v -E '(IBOutlet|IBAction|fatalError)' | wc -l | tr -d ' ')
if [ "$FORCE_UNWRAP" -gt 0 ]; then
    print_warning "Found $FORCE_UNWRAP potential force unwrapping operators"
    print_info "Consider using safe unwrapping patterns"
fi

# Run a quick syntax check
print_info "Running Swift syntax check..."
for file in $SWIFT_FILES; do
    if [ -f "$file" ]; then
        if ! swift -frontend -parse "$file" >/dev/null 2>&1; then
            print_error "Syntax error in $file"
            exit 1
        fi
    fi
done

print_status "Syntax check passed"

# Success
print_status "All pre-commit checks passed! ðŸŽ‰"
print_info "Commit will proceed..."

exit 0